environment:
  global:
    PROJECT_NAME: simplification
    TEST_DEPENDS: "nose"
    CMD_IN_ENV: "cmd /E:ON /V:ON /C %APPVEYOR_BUILD_FOLDER%\\ci\\appveyor\\windows_sdk.cmd"
    TARBALL_KEY:
      secure: t4hDWCSZFjJWo7sENSHNyWu9ez50xX9mU02G4gy/IZ/+cttOPJYVd4CY7UgRekB8

  matrix:
    - PYTHON: "C:\\Miniconda"
      PYTHON_VERSION: "2.7"
      PYTHON_ARCH: "32"
    - PYTHON: "C:\\Miniconda-x64"
      PYTHON_VERSION: "2.7"
      PYTHON_ARCH: "64"
    - PYTHON: "C:\\Miniconda3"
      PYTHON_VERSION: "3.4"
      PYTHON_ARCH: "32"
    - PYTHON: "C:\\Miniconda3-x64"
      PYTHON_VERSION: "3.4"
      PYTHON_ARCH: "64"
    - PYTHON: "C:\\Miniconda35"
      PYTHON_VERSION: "3.5"
      PYTHON_ARCH: "32"
    - PYTHON: "C:\\Miniconda35-x64"
      PYTHON_VERSION: "3.5"
      PYTHON_ARCH: "64"
    - PYTHON: "C:\\Miniconda36"
      PYTHON_VERSION: "3.6"
      PYTHON_ARCH: "32"
    - PYTHON: "C:\\Miniconda36-x64"
      PYTHON_VERSION: "3.6"
      PYTHON_ARCH: "64"

# We always use a 64-bit machine, but can build x86 distributions
# with the TARGET_ARCH variable.
platform:
    - x64

matrix:
    fast_finish: true

install:
    # Install miniconda and fix headers
    - ps: .\\ci\\appveyor\\install.ps1
    - ps: .\\ci\\appveyor\\missing-headers.ps1
    - SET PATH=%PYTHON%;%PYTHON%\Scripts;%PYTHON%\Library\bin;%PATH%
    - SET PATH=%PATH%;C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\bin
    - conda info

    # Check that we have the expected version and architecture for Python
    - python --version
    - python -c "import struct; print(struct.calcsize('P') * 8)"

build_script:
  # Install build requirements
  - conda install -q --yes --file dev-requirements.txt
  # get correct Rust DLL
  - python ci/pre_install.py
  # build wheel
  # - "%CMD_IN_ENV% python setup.py bdist_wheel"
  - "%CMD_IN_ENV% pip wheel . -w dist/ --no-deps"
  - ls dist/*
  # dump rdp dll dependencies
  - dumpbin /dependents simplification/rdp.dll > dumpbin_rdp_dll.txt
  - appveyor PushArtifact dumpbin_rdp_dll.txt

test_script:
  # create test env
  - conda create --yes -n test_env python=%PYTHON_VERSION% %TEST_DEPENDS%
  - activate test_env
  - pip install -r dev-requirements.txt
  # install from wheel
  - pip install %PROJECT_NAME% --no-index -f C:/projects/%PROJECT_NAME%/dist
  - nosetests %PROJECT_NAME%

after_test:
  # - cd C:/projects/%PROJECT_NAME%
  # needlessly generate pyd in-place, so I can peer at its dependencies
  # - python setup.py build_ext --inplace
  # - dumpbin /dependents %PROJECT_NAME%/cutil.pyd
  # - dir %PROJECT_NAME%

artifacts:
  # Archive the generated packages in the ci.appveyor.com build report.
  - path: dist\*

before_deploy:
  # Generate artifacts for release
  - cd C:/projects/%PROJECT_NAME%/dist
    # release zipfile will look like 'simplification-v1.2.3-x86_64-pc-windows-gnu'
  - 7z a ../%PROJECT_NAME%-%APPVEYOR_REPO_TAG_NAME%-%TARGET%-%PYTHON_RELEASE_VERSION%.zip *
  - appveyor PushArtifact ../%PROJECT_NAME%-%APPVEYOR_REPO_TAG_NAME%-%TARGET%-%PYTHON_RELEASE_VERSION%.zip

deploy:
  appveyor_repo_tag: true
  tag: $(APPVEYOR_REPO_TAG_NAME)
  release: $(APPVEYOR_REPO_TAG_NAME)
  description: 'Binaries'
  provider: GitHub
  auth_token:
    secure: UZz5wMJVxWEJQtyXbSZaXI55fmaLYq17RWBBOeIV6WabCmFK/62AN7L6tTmT9gzY
  artifact: /.*\.zip/
  draft: false
  prerelease: false
  on:
    appveyor_repo_tag: true
    CHANNEL: stable

branches:
  only:
    - master
    - /v\d\.\d\.\d/
